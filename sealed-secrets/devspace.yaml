version: v1beta11

commands:

- name: init
  command: |-
    devspace deploy --profile=init --deployments=sealed-secrets

- name: backup-master-key
  description: Takes a backup of the master key, which can then be shared in the devteam.
  command: |-
    mkdir -p ~/.devspace
    kubectl get secret -n kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key -o yaml >~/.devspace/sealed-secrets-master.key

- name: restore-master-key
  description: Inserts the master key into the current cluster.
  command: |-
    kubectl apply -f ~/.devspace/sealed-secrets-master.key
    kubectl delete pod -n kube-system -l name=sealed-secrets-controller

hooks:

- command: until kubectl wait --for=condition=available deployment.apps/sealed-secrets-controller -n kube-system --timeout=120s; do sleep 2; done
  os: darwin,linux
  events: [ "after:deploy:sealed-secrets" ]

deployments:
- name: sealed-secrets
  namespace: kube-system
  kubectl:
    manifests:
    - https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.16.0/controller.yaml

profiles:
- name: init
  merge:
    hooks:
      - command: "devspace run restore-master-key"
        events: ["after:deploy:sealed-secrets"]
