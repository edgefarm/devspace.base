version: v1beta11

vars:
  - name: K3D_CLUSTER_NAME
    source: env
  - name: K3D_CONFIG
    source: env
  - name: K3D_EXTRA_ARGS
    source: env
    default: ""

commands:
  - name: activate
    description: Configure environment to point to this cluster.
    command: |-
      kubectl config use-context k3d-${K3D_CLUSTER_NAME}
      kubectl config set-context --current --namespace ${K3D_CLUSTER_NAME}
  - name: purge
    description: Delete cluster resources (except container registry).
    command: |-
      k3d cluster delete ${K3D_CLUSTER_NAME}
      kubectl config delete-context k3d-${K3D_CLUSTER_NAME} 2>/dev/null || true
      kubectl config delete-cluster k3d-${K3D_CLUSTER_NAME} 2>/dev/null || true
      kubectl config delete-user admin@k3d-${K3D_CLUSTER_NAME} 2>/dev/null || true
  - name: init
    description: Setup registry, custer and activate environment.
    command: |-
      k3d cluster create ${K3D_CLUSTER_NAME} --config ${K3D_CONFIG} ${K3D_EXTRA_ARGS}
      export K3D_CLUSTER_NAME=${K3D_CLUSTER_NAME}
      export K3D_CONFIG=${K3D_CONFIG}
      devspace run internal-ensure-registry-exists
      devspace run internal-create-cluster
  - name: internal-ensure-registry-exists
    description: Create registry, if not exists. (Do not use directly)
    command: |-
      k3d registry create registry.k3d.localhost --port 5000 2>/dev/null || true
  - name: internal-create-cluster
    description: Create registry, if not exists. (Do not use directly)
    command: |-
      k3d kubeconfig merge ${K3D_CLUSTER_NAME} --output $HOME/.kube/config
      devspace run activate
